!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).ODA=e()}(this,(function(){"use strict";function t(t){return t.then((t=>t.json()))}function e(t){return t.then((t=>t.text()))}function i(t){return t.then((t=>t.arrayBuffer()))}function s(t,e,i,s){const r={method:t,headers:e,body:i};return s&&(r.signal=s),r}function r(t){return t>400?Promise.reject(t):Promise.resolve()}function n(t){return t.then((e=>r(e.status).then((()=>t),(()=>e.json().then((t=>Promise.reject(new Error(t.description))))))))}function a(t,e,i){return n(fetch(t,s("GET",e,null,i)))}function o(t,e){const i=t.headers.get("Content-Length"),s=t.body.tee();return function(t,e){const i=t.getReader();let s=0;i.read().then((function t(r){r.done||i.read().then(t).catch(console.error),r.value&&(s+=r.value.length),e(s)})).catch(console.error)}(s[0],(t=>e&&e(t/i))),new Response(s[1])}function h(t,{headers:e,method:i,body:s,uploadProgress:n,downloadProgress:a}){return new Promise(((o,h)=>{const l=new XMLHttpRequest;for(var d in l.open(i,t,!0),e)l.setRequestHeader(d,e[d]);function c(t){return t.lengthComputable?t.loaded/t.total:1}l.upload.onprogress=t=>n&&n(c(t)),l.onprogress=t=>a&&a(c(t)),l.onloadend=t=>r(l.status).then((()=>o(l)),(()=>h(new Error(function(t){try{return JSON.parse(t).description}catch{return t}}(t.target.responseText))))),l.onerror=t=>h(t),l.send(s)}))}function l(t){return t.replace(/^\/*/,"/")}class d{constructor(t,e){this.data=t,this.file=e}get id(){return this.data.id}get(t,e){const i=l(t);return this.file.get(`/markup/${this.id}${i}`,e)}post(t,e){const i=l(t);return this.file.post(`/markup/${this.id}${i}`,e)}put(t,e){const i=l(t);return this.file.put(`/markup/${this.id}${i}`,e)}delete(t,e){const i=l(t);return this.file.delete(`/markup/${this.id}${i}`,e)}saveMarkup(){return t(this.post("/",this.data))}getMarkup(){return t(this.get("/"))}deleteMarkup(){return t(this.delete("/"))}}class c{constructor(t,e){this.data=t,this.file=e}get id(){return this.data.id}get(t,e){const i=l(t);return this.file.get(`/${i}`,e)}post(t,e){const i=l(t);return this.file.post(`/${i}`,e)}put(t,e){const i=l(t);return this.file.put(`/${i}`,e)}delete(t,e){const i=l(t);return this.user.delete(`/${i}`,e)}downloadResource(t,e,i){return this.file.downloadResource(t,e,i)}partialDownloadResource(t,e,i){return this.file.partialDownloadResource(t,e,i)}getReferences(){return this.file.getReferences()}getViewPoints(){if(!this.file.getViewPoints)throw new Error("Assembly not support viewpoint");return this.file.getViewPoints().then((t=>t.filter((t=>t.custom_fields.modelId===this.id))))}postViewpoint(t){if(!this.file.postViewpoint)throw new Error("Assembly not support viewpoint");return this.file.postViewpoint({...t,custom_fields:{modelId:this.id}})}getViewpoint(t){if(!this.file.getViewpoint)throw new Error("Assembly not support viewpoint");return this.file.getViewpoint(t)}deleteViewpoint(t){if(!this.file.deleteViewpoint)throw new Error("Assembly not support viewpoint");return this.file.deleteViewpoint(t)}getSnapshot(t){if(!this.file.getSnapshot)throw new Error("Assembly not support viewpoint");return this.file.getSnapshot(t)}getSnapshotData(t,e){if(!this.file.getSnapshotData)throw new Error("Assembly not support viewpoint");return this.file.getSnapshot(t,e)}}class m{constructor(t,e){this.fileInfo=t,this.user=e}get id(){return this.fileInfo.id}get(t,e){const i=l(t);return this.user.get(`/files/${this.id}${i}`,e)}post(t,e){const i=l(t);return this.user.post(`/files/${this.id}${i}`,e)}put(t,e){const i=l(t);return this.user.put(`/files/${this.id}${i}`,e)}delete(t,e){const i=l(t);return this.user.delete(`/files/${this.id}${i}`,e)}getProperties(){return t(this.get("/properties"))}getProperty(e){return t(this.get(`/properties?handle=${e}`))}getModels(){return t(this.get("/geometry")).then((t=>t.map((t=>new c(t,this)))))}postMetadata(e){return t(this.post("/geometry",e))}postFileDownloads(e,i){const s=new FormData;return s.append("file",e),t(this.post("/downloads",s))}downloadFile(){return i(this.get("/downloads"))}downloadResource(t,e,i){return this.get(`/downloads/${t}`,i).then((t=>o(t,e))).then((t=>t.arrayBuffer()))}async partialDownloadResource(t,e,i){const s=l(`/files/${this.id}/downloads/${t}`),r=await fetch(`${this.user.url}${s}`,{headers:this.user.headers,signal:e}),n=r.headers.get("content-length"),a=parseInt(n,10);let o=0;const h=r.body.getReader();for(;;){const{done:t,value:e}=await h.read();if(t)break;o+=e.byteLength,i(o/a,e)}}getFileInfo(){return t(this.get("/"))}putFile(e){return t(this.put("/",e))}deleteFile(){return this.user.deleteFile(this.id)}getMarkupList(){return t(this.get("/markup")).then((t=>t.result.map((t=>new d(t,this)))))}postMarkup(e){return t(this.post("/markup/",e))}deleteMarkup(e){return t(this.delete(`/markup/${e}`))}getMarkup(e){return t(this.get(`/markup/${e}`))}createJob(t){return this.user.postJob(this.id,t)}getReferences(){return t(this.get("/references"))}putReferences(e){return t(this.put("/references",e))}downloadReferenceFile(t,e){return i(this.user.downloadReferenceFile(this.id,t,e))}getViewPoints(){return t(this.get("/viewpoints")).then((t=>t.result))}postViewpoint(e){return t(this.post("/viewpoints",e))}getViewpoint(e){return t(this.get(`/viewpoints/${e}`))}deleteViewpoint(e){return t(this.delete(`/viewpoints/${e}`))}getSnapshot(t){return e(this.get(`/viewpoints/${t}/snapshot`))}getSnapshotData(t,i){return e(this.get(`/viewpoints/${t}/bitmaps/${i}`))}}class u{constructor(t,e){this.data=t,this.user=e}get id(){return this.data.id}get done(){return"done"===this.data.state}get state(){return this.data.state}get fileId(){return this.data.fileId}get assemblyId(){return this.data.assemblyId}get createdAt(){return this.data.createdAt}get startedAt(){return this.data.startedAt}get lastUpdate(){return this.data.lastUpdate}get outputFormat(){return this.data.outputFormat}refresh(){return this.user.getJob(this.id).then((t=>this.data=t)).then((()=>this))}editJob(t){return this.user.editJob(this.id,t).then((t=>this.data=t)).then((()=>this))}delete(){return this.user.deleteJob(this.id)}waitForDone(){return function(t,e={timeout:6e5,interval:3e3}){return new Promise(((i,s)=>{let r=0;const n=setInterval((()=>{t()&&(clearInterval(n),i()),r+=e.interval,r>=e.timeout&&(s(),clearInterval(n))}),e.interval)}))}((()=>this.refresh()&&this.done))}}class p{constructor(t,e){this._data=t,this._user=e}delete(){const{id:t}=this._data;return this._user.delete(`/projects/${t}`)}save(){const{id:e}=this._data;return t(this._user.put(`/projects/${e}`,this._data))}}class g{constructor(t,e){this._data=t,this._user=e}_get(t,e){const i=l(t||"");return this._user.get(`/assemblies/${this._data.id}${i}`,e)}_post(t,e){const i=l(t||"");return this._user.post(`/assemblies/${this._data.id}${i}`,e)}_put(t,e){const i=l(t||"");return this._user.put(`/assemblies/${this._data.id}${i}`,e)}_delete(t,e){const i=l(t||"");return this._user.delete(`/assemblies/${this._data.id}${i}`,e)}getProperties(){return t(this._get("/properties"))}getProperty(e){return t(this._get(`/properties?handle=${e}`))}getModels(){return t(this._get("/geometry")).then((t=>t.map((t=>new c(t,this)))))}downloadResource(t,e,i){return this._get(`/downloads/${t}`,i).then((t=>o(t,e))).then((t=>t.arrayBuffer()))}async partialDownloadResource(t,e,i){const s=l(`/assemblies/${this._data.id}/downloads/${t}`),r=await fetch(`${this._user.url}${s}`,{headers:this._user.headers,signal:e}),n=r.headers.get("content-length"),a=parseInt(n,10);let o=0;const h=r.body.getReader();for(;;){const{done:t,value:e}=await h.read();if(t)break;o+=e.byteLength,i(o/a,e)}}delete(){return this._delete()}save(){return this._put("",this._data)}}class w{constructor(t,e,i){if(this.data=t,this.url=e,this.headers={Authorization:t.tokenInfo.token},this.opt=i,!this.opt)throw new Error("opt can not be undefined")}get(t,e){const i=l(t);return a(`${this.url}${i}`,this.headers,e)}post(t,e){const i=l(t);return function(t,e,i){return"object"==typeof i?i instanceof FormData||i instanceof ArrayBuffer||i instanceof Blob||(i=JSON.stringify(i),e={...e,"Content-Type":"application/json"}):e={...e,"Content-Type":"application/json"},e={...e,"Access-Control-Allow-Origin":"*",pragma:"no-cache","cache-control":"no-cache"},n(fetch(t,s("POST",e,i)))}(`${this.url}${i}`,this.headers,e)}put(t,e){const i=l(t);return function(t,e,i){return"object"==typeof i?i instanceof FormData||i instanceof ArrayBuffer||i instanceof Blob||(i=JSON.stringify(i),e={...e,"Content-Type":"application/json"}):e={...e,"Content-Type":"application/json"},e={...e,"Access-Control-Allow-Origin":"*",pragma:"no-cache","cache-control":"no-cache"},n(fetch(t,s("PUT",e,i)))}(`${this.url}${i}`,this.headers,e)}delete(t,e){const i=l(t);return function(t,e,i){return n(fetch(t,s("DELETE",e,i)))}(`${this.url}${i}`,this.headers,e)}getUsers(){return t(this.get("/users"))}getUserInfo(){return t(this.get("/user"))}putUserInfo(e){return t(this.put("/user",e))}save(){return this.putUserInfo(this.data)}getFile(e){return t(this.get(`/files/${e}`)).then((t=>new m(t,this)))}getFiles(e,i,s,r,n,a){const o=[];void 0!==e&&o.push("start="+e),void 0!==i&&o.push("limit="+i),s&&o.push("name="+s),r&&o.push("ext="+r.toLowerCase()),n&&o.push("id="+n.join("|")),a&&o.push("sortBy=desc");const h=0!==o.length?"?"+o.join("&"):"";return t(this.get(`/files${h}`)).then((t=>({...t,result:t.result.map((t=>new m(t,this)))})))}postFile(t,e){const i=new FormData;return i.append("file",t),h(`${this.url}/files/`,{method:"POST",headers:this.headers,body:i,uploadProgress:e}).then((t=>JSON.parse(t.responseText))).then((t=>new m(t,this)))}deleteFile(e,i){return t(this.delete(`/files/${e}`,i))}getJobs(e=null,i=null,s=null,r=null){const n=[e?`state=${e}`:"",i?`limit=${i}`:"",s?`start=${s}`:"",r?"sortBy=desc":""].filter((t=>t)),a=n.length?`?${n.join("&")}`:"";return t(this.get(`/jobs${a}`)).then((t=>({...t,result:t.result.map((t=>new u(t,this)))})))}postJob(e,i){const s=this.opt.useVSFX?{useVSFX:""}:{};return t(this.post("/jobs",{fileId:e,outputFormat:i,parameters:s})).then((t=>new u(t,this)))}getJob(e){return t(this.get(`/jobs/${e}`)).then((t=>new u(t,this)))}deleteJob(e){return t(this.delete(`/jobs/${e}`))}editJob(e){return t(this.put(`/jobs/${this.id}`,e)).then((t=>new u(t,this)))}downloadReferenceFile(t,e,i){return this.get(`/files/${t}/downloads`,i).then((t=>o(t,e))).then((t=>t.arrayBuffer()))}getProjects(){return t(this.get("/projects")).then((t=>t.map((t=>new p(t,this)))))}createProject(e,i,s,r,n){return t(this.post("/projects",{name:e,description:i,startDate:s.toISOString(),endDate:r.toISOString(),avatarUrl:n})).then((t=>new p(t,this)))}getProjectById(e){return t(this.get(`/projects/${e}`)).then((t=>new p(t,this)))}createAssembly(e,i){return t(this.post("/assemblies",{name:i,files:e})).then((t=>new g(t,this)))}getAssemblyById(e){return t(this.get(`/assemblies/${e}`)).then((t=>new g(t,this)))}getAssemblies(e,i,s,r,n){const a=[];void 0!==e&&a.push("start="+e),void 0!==i&&a.push("limit="+i),s&&a.push("name="+s),r&&a.push("id="+r.join("|")),n&&a.push("sortBy=desc");const o=0!==a.length?"?"+a.join("&"):"";return t(this.get(`/assemblies${o}`)).then((t=>({...t,result:t.result.map((t=>new g(t,this)))})))}deleteAssembly(e){return t(this.delete(`/assemblies/${e}`))}}class v{constructor(t,e,i){this._impl=t,this._file=e,this._assembly=i}get file(){return this._file}get assembly(){return this._assembly}get default(){return this._impl.data.default}get database(){return this._impl.data.database}get fileId(){return this._impl.data.fileId}get geometry(){return this._impl.data.geometry}get id(){return this._impl.data.id}get name(){return this._impl.data.name}get version(){return this._impl.data.version}getViewpoints(){return this._impl.getViewPoints()}saveViewpoint(t){return this._impl.postViewpoint(t)}deleteViewpoint(t){return this._impl.deleteViewpoint(t)}getSnapshot(t){return this._impl.getSnapshot(t)}getSnapshotData(t,e){return this._impl.getSnapshotData(t,e)}downloadResource(t,e,i){return this._impl.downloadResource(t,e,i)}partialDownloadResource(t,e,i){return this._impl.partialDownloadResource(t,e,i)}getReferences(){return this._impl.getReferences()}}class y{constructor(t,e){this._impl=t,this.app=e}get id(){return this._impl._data.id}get name(){return this._impl._data.name}set name(t){this._impl._data.name=t}get authorization(){return this._impl._data.authorization}get createdAt(){return this._impl._data.createdAt}get updatedAt(){return this._impl._data.updatedAt}get startDate(){return this._impl._data.startDate}set startDate(t){this._impl._data.startDate=t.toISOString()}get endDate(){return this._impl._data.endDate}set endDate(t){this._impl._data.endDate=t.toISOString()}get description(){return this._impl._data.description}set description(t){this._impl._data.description=t}get avatarUrl(){return this._impl._data.avatarUrl}set avatarUrl(t){this._impl._data.avatarUrl=t}get customFields(){return this._impl._data.customFields}set customFields(t){this._impl._data.customFields=t}get public(){return this._impl._data.public}set public(t){this._impl._data.public=t}save(){return this._impl.save()}delete(){return this._impl.delete()}}class _{constructor(t,e){this._impl=t,this._plugin=e}get data(){return this._impl.data}get avatarImage(){return this._impl.data.avatarImage}set avatarImage(t){this._impl.data.avatarImage=t,this._impl.save()}get canCreateProject(){return this._impl.data.canCreateProject}get createAt(){return this._impl.data.createAt}get customFields(){return this._impl.data.customFields}get email(){return this._impl.data.email}get firstName(){return this._impl.data.firstName}set firstName(t){this._impl.data.firstName=t,this._impl.save()}get lastModified(){return this._impl.data.lastModified}get lastName(){return this._impl.data.lastName}set lastName(t){this._impl.data.lastName=t,this._impl.save()}get lastSignIn(){return this._impl.data.lastSignIn}get projectsLimit(){return this._impl.data.projectsLimit}get userName(){return this._impl.data.userName}set userName(t){this._impl.data.userName=t,this._impl.save()}getUsers(){return this._impl.getUsers()}}class f{constructor(t,e){this._impl=t,this._app=e}get user(){return new _(this.impl.user,this._app)}get id(){return this._impl.id}get done(){return this._impl.done}get state(){return this._impl.state}get fileId(){return this._impl.fileId}get assemblyId(){return this._impl.assemblyId}get createdAt(){return this._impl.createdAt}get startedAt(){return this._impl.startedAt}get lastUpdate(){return this._impl.lastUpdate}refresh(){return this._impl.refresh()}editJob(t){return this._impl.editJob(t)}delete(){return this._impl.delete()}}class P{constructor(t,e){this._impl=t,this.app=e}get user(){return new _(this._impl.user,this.app)}get created(){return this._impl.fileInfo.created}get exports(){return this._impl.fileInfo.exports}get id(){return this._impl.fileInfo.id}get metadata(){return this._impl.fileInfo.metadata}get owner(){return this._impl.fileInfo.owner}get preview(){return this._impl.fileInfo.preview}set preview(t){this._impl.fileInfo.preview=t}get properties(){return this._impl.fileInfo.properties}get size(){return this._impl.fileInfo.size}get type(){return this._impl.fileInfo.type}get version(){return this._impl.fileInfo.version}get name(){return this._impl.fileInfo.name}set name(t){this._impl.fileInfo.name=t}get geometryStatus(){return this._impl.fileInfo.geometryStatus}get propertiesStatus(){return this._impl.fileInfo.propertiesStatus}getModels(){return this._impl.getModels().then((t=>t.map((t=>new v(t,this)))))}getProperty(t){return this._impl.getProperty(t)}getProperties(){return this._impl.getProperties()}getViewPoints(){return this._impl.getViewPoints()}delete(){return this._impl.deleteFile()}downloadResource(t,e,i){return this._impl.downloadResource(t,e,i)}save(){return this._impl.putFile(this._impl.fileInfo)}checkout(){return this._impl.getFileInfo().then((t=>this._impl.fileInfo=t)).then((()=>this))}createReferences(t){return this.putReferences(t)}getReferences(){return this._impl.getReferences()}putReferences(t){return this._impl.putReferences(t)}extractGeometry(){return this._impl.createJob("geometry").then((t=>new f(t,this.app)))}extractProperties(){return this._impl.createJob("properties").then((t=>new f(t,this.app)))}}class b{constructor(t,e){this._userImpl=t,this._plugin=e,this._intervalId=0,this.interval=5e3,this.jobs=[]}start(){this._intervalId=setInterval((()=>{this.update()}),this.interval)}async update(){const t=[...(await this._userImpl.getJobs("running")).result,...(await this._userImpl.getJobs("waiting")).result],e=(i=this.jobs,s=t,i.filter((t=>!s.find((e=>t.id===e.id)))));var i,s;this.jobs=t;const r=await e.reduce(((t,e)=>t.then((t=>this._userImpl.getFile(e.fileId).then((e=>t.push(e)&&t))))),Promise.resolve([]));r.length&&this._plugin.emit({type:"jobs-complete",data:r.map((t=>new P(t,this._plugin)))})}stop(){clearInterval(this._intervalId),this._intervalId=0}}class E{constructor(){this.draggers=[],this.emitEvent=this.emitEvent.bind(this)}addDragger(t,e){const i={dragger:t,events:e.map((e=>({key:e,fn:i=>t[e]&&t[e](i)})))};i.events.forEach((t=>this.addEventListener(t.key,t.fn))),this.draggers.push(i)}removeDragger(t){this.draggers.filter((e=>e.dragger===t)).forEach((t=>{t.events.forEach((t=>this.removeEventListener(t.key,t.fn)))})),this.draggers=this.draggers.filter((e=>e.dragger!==t))}addEventListener(t,e){void 0===this._listeners&&(this._listeners={});const i=this._listeners;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)}removeEventListener(t,e){if(void 0===this._listeners)return;const i=this._listeners[t];if(void 0!==i){const t=i.indexOf(e);-1!==t&&i.splice(t,1)}}emitEvent(t){if(void 0===this._listeners)return;const e=this._listeners[t.type];if(void 0!==e){t.target||(t.target=this);const i=e.slice(0);for(let e=0,s=i.length;e<s;e++)i[e].call(this,t);t.target===this&&(t.target=null)}}removeAllListeners(){this._listeners=[]}attach(t,e){return t.addEventListener(e,this.emitEvent)}detach(t,e){return t.removeEventListener(e,this.emitEvent)}}const x=(t=>{const e={};return(...i)=>{const s=JSON.stringify(i);return e[s]=e[s]||t(...i),e[s]}})(((t,e)=>function(t){return new Promise(((e,i)=>{const s=document.createElement("script");s.src=t,s.async=!0,s.onload=e,s.onerror=i,document.body.appendChild(s)}))}(t).then((()=>new Promise((i=>{const s=window.getVisualizeLibInst({urlMemFile:t+".wasm",TOTAL_MEMORY:134217728,onprogress:e});s.postRun.push((()=>i(s)))})))))),V=(t,e,i,s,r)=>{const n=r.setTranslation([t.x,t.y,t.z]),a=r.setToRotation(e.angle,[e.x,e.y,e.z],s),o=r.setToScaling(i,s);return n.postMultBy(a).postMultBy(o)};const S="$OVERLAY_VIEW_NAME";class A extends class{constructor(t){this.m_module=t}getViewer(){return this.m_module.getViewer()}getModel(){return this.getViewer().getMarkupModel()}copyPoint(t){const e=new this.m_module.Point3d;return e.set(t.x,t.y,t.z),e}createVector3d(){return new this.m_module.Vector3d}createPoint3d(){return new this.m_module.Point3d}createMatrix3d(){return new this.m_module.Matrix3d}createPlane(){return new this.m_module.OdTvPlane}toVector(t){return this.m_module.Vector3d.createFromArray(t)}toGeVector(t){return[t.x,t.y,t.z]}toGePoint(t){return[t.x,t.y,t.z]}toPoint(t){return this.m_module.Point3d.createFromArray(t)}screenToWorld(t,e){return this.toPoint(this.m_module.getViewer().screenToWorld(t,e))}toDoubleArray(t){const e=[];for(let i=0;i<t.length;i++)e.push(t[i].x),e.push(t[i].y),e.push(t[i].z);return e}correctCameraTarget(){const t=this.getViewParams();let e=this.m_module.getViewer().getActiveExtents();const{min:i,max:s}=e,r=this.toGePoint(t.target);r.x>=i.x&&r.y>=i.y&&r.z>=i.z&&r.x<=s.x&&r.y<=s.y&&r.z<=s.z||(t.target=e.center(),this.setViewParams(t))}setViewParams(t){const e=this.m_module.getViewer().getActiveTvExtendedView();e.setView(t.position,t.target,t.upVector,t.viewFieldWidth,t.viewFieldHeight,t.perspective),e.delete&&e.delete()}getViewParams(){const t=this.m_module.getViewer().activeView,e={position:t.viewPosition,target:t.viewTarget,upVector:t.upVector,viewFieldWidth:t.viewFieldWidth,viewFieldHeight:t.viewFieldHeight,perspective:t.perspective};return t.delete&&t.delete(),e}}{constructor(t){super(t.visualizeJs),this.subject=t,this.needInputText=!1,this.touchStartPoints={x:0,y:0},this.touchEndPoints={x:0,y:0},this.mouseDownPosition={x:0,y:0},this.autoSelect=!1,this.onmessage=new Function,this.onmessage=t=>this.subject.emitEvent(t),this.subject.eventEmitter.addDragger(this,["mousemove","mouseleave","mousedown","mouseup","mouseleave","click","touchstart","touchend","touchcancel","touchmove","dblclick"])}dispose(){this.subject.eventEmitter.removeDragger(this)}relativeCoords(t){const e=t.target.getBoundingClientRect();t.touches&&t.touches[0]&&(t=t.touches[0]);const i=t.clientX-e.left,s=t.clientY-e.top,r=this.m_module.canvas.getBoundingClientRect(),n=r.left,a=r.top,o=r.right,h=r.bottom;return i<=n||i>=o||s<=a||s>=h?{x:i*window.devicePixelRatio,y:s*window.devicePixelRatio,isValid:!1}:{x:i*window.devicePixelRatio,y:s*window.devicePixelRatio,isValid:!0}}touchstart(t){t.touches.length>1&&t.preventDefault();const e=this.relativeCoords(t);this.isDragging=!0,this.touchStartPoints.x=e.x,this.touchStartPoints.y=e.y,this.touchEndPoints.x=e.x,this.touchEndPoints.y=e.y,this.start(e.x,e.y),this.onmessage({type:"update"})}touchend(t){this.end(this.touchEndPoints.x,this.touchEndPoints.y),this.isDragging=!1,this.onmessage({type:"update"})}touchmove(t){const e=this.relativeCoords(t);t.touches[0],this.touchEndPoints.x=e.x,this.touchEndPoints.y=e.y,this.drag(e.x,e.y,this.touchStartPoints.x-e.x,this.touchStartPoints.y-e.y),this.isDragging&&this.onmessage({type:"update"})}mousedown(t){const e=this.relativeCoords(t);this.isDragging=!0,this.mouseDownPosition={x:e.x,y:e.y},this.start(this.mouseDownPosition.x,this.mouseDownPosition.y,t.clientX,t.clientY),this.onmessage({type:"update"})}mouseup(t){const e=this.relativeCoords(t);this.end(e.x,e.y),this.isDragging=!1,this.onmessage({type:"update"})}mouseleave(t){this.mouseup(t)}mousemove(t){const e=this.relativeCoords(t);e.isValid?(this.drag(e.x,e.y,t.movementX,t.movementY),this.isDragging&&this.onmessage({type:"update"})):this.mouseup(t)}click(t){const e=this.relativeCoords(t),i=e.x,s=e.y,r=Math.abs(i-this.mouseDownPosition.x)<5&&Math.abs(s-this.mouseDownPosition.y)<5,n=this.getViewer();if(n&&n.getEnableAutoSelect()&&r){n.unselect(),n.select(i,s,i,s);const t=n.getSelected();t.isNull()||0===t.numItems()||this.onmessage({type:"select",data:t}),this.onmessage({type:"update"})}}dblclick(t){const e=this.getViewer(),i=this.relativeCoords(t),s=i.x,r=i.y,n=e.getActiveDevice(),a=n.viewAt([s,r]);if(a&&!a.active)e.activeView=a,a.delete(),this.onmessage({type:"update"});else if(e&&e.getEnableAutoSelect()){const t=e.getSelected();if(!t.isNull()&&0!==t.numItems()){const i=t.getIterator(),s=i.getEntity();e.zoomToEntity(s),this.onmessage({type:"zoomToEntity",data:s}),this.onmessage({type:"update"}),this.deleteAll([i,s])}t.delete()}n.delete()}start(t,e){}drag(t,e){}end(t,e){}beginInteractivity(){const t=this.getViewer().activeView;t.beginInteractivity&&(t.beginInteractivity(15),this.onmessage({type:"update"})),t.delete()}endInteractivity(){const t=this.getViewer().activeView;if(t.endInteractivity){t.endInteractivity();const e=this.getViewer().getActiveDevice(),i=this.m_module.canvas;e.invalidate([0,0,i.width,i.height]),e.delete(),this.onmessage({type:"update"})}t.delete()}getActiveMarkupEntity(t){!function(t){let e=t.getViewByName(S);const i=t.activeView;if(!e){const s=t.getMarkupModel(),r=t.getActiveDevice();e=r.createView(S,!1),e.addModel(s),i.addSibling(e),r.addView(e)}e.viewPosition=i.viewPosition,e.viewTarget=i.viewTarget,e.upVector=i.upVector,e.viewFieldWidth=i.viewFieldWidth,e.viewFieldHeight=i.viewFieldHeight;const s=e.getViewport();e.setViewport(s.lowerLeft,s.upperRight),e.vportRect=i.vportRect}(this.getViewer());const e=this.getViewer().getMarkupModel(),i="$MarkupTempEntity_"+t;let s=e.appendEntity(i);const r=s.openObject();return r.setColor(255,0,0),r.setLineWeight(2),r.delete(),e.delete(),s}deleteAll(t){for(let e of t)e&&e.delete&&e.delete()}}class F extends A{constructor(...t){super(...t),this.press=!1,this.m_module.getViewer().setEnableAutoSelect(!0)}start(t,e){this.press=!0,this.m_start=this.screenToWorld(t,e),this.beginInteractivity()}drag(t,e,i,s){if(this.press){const{Vector3d:i}=this.m_module,s=this.getViewParams(),r=this.screenToWorld(t,e),n=this.m_start.sub(r),a=n.asVector(),o=i.createFromArray(s.target),h=o.add(a);s.target=h.toArray();const l=i.createFromArray(s.position),d=l.add(a);s.position=d.toArray(),this.setViewParams(s),r.delete(),n.delete(),a.delete(),o.delete(),h.delete(),l.delete(),d.delete()}}end(t,e){this.press=!1,this.endInteractivity(),this.m_start&&this.m_start.delete(),this.m_start=null}}class z extends A{constructor(...t){super(...t),this.press=!1,this.getViewer().setEnableAutoSelect(!0)}start(t,e){this.press=!0,this.m_viewCenter=this.getCenter(),this.m_startPoint={x:t,y:e};const i=this.getViewer().activeView;this.startCameraParams={position:i.viewPosition,target:i.viewTarget,upVector:i.upVector,viewFieldWidth:i.viewFieldWidth,viewFieldHeight:i.viewFieldHeight,perspective:i.perspective},i.delete(),this.beginInteractivity()}setDefaultViewParams(){const t=this.getViewer().getActiveTvExtendedView();t.setView(this.startCameraParams.position,this.startCameraParams.target,this.startCameraParams.upVector,this.startCameraParams.viewFieldWidth,this.startCameraParams.viewFieldHeight,this.startCameraParams.perspective),t.delete()}getSideVector(t){const e=this.toVector(t.upVector),i=this.toPoint(t.target),s=this.toPoint(t.position),r=i.sub(s),n=r.asVector(),a=e.crossProduct(n),o=a.normalize();return this.deleteAll([r,e,i,s,n,a]),o}calculateXOrbit(t,e,i){{const s=this.toPoint(t.position),r=this.toPoint(this.m_viewCenter),n=s.rotateByBasePoint(e,i,r);t.position=n.toArray(),this.deleteAll([s,r,n])}{const s=this.toPoint(t.target),r=this.toPoint(this.m_viewCenter),n=s.rotateByBasePoint(e,i,r);t.target=n.toArray(),this.deleteAll([s,r,n])}{const e=this.toPoint(t.position),s=this.toPoint(t.target),r=this.toPoint(this.m_viewCenter),n=s.sub(e),a=n.asVector(),o=a.crossProduct(i),h=o.normalize();t.upVector=h.toArray(),this.deleteAll([e,s,r,n,a,o,h])}}calculateYOrbit(t,e,i){{const i=this.toPoint(t.position),s=this.toPoint(this.m_viewCenter),r=this.toVector(this.m_module.Vector3d.kZAxis),n=i.rotateByBasePoint(e,r,s);t.position=n.toArray(),this.deleteAll([r,i,s,n])}{const i=this.toPoint(t.target),s=this.toPoint(this.m_viewCenter),r=this.toVector(this.m_module.Vector3d.kZAxis),n=i.rotateByBasePoint(e,r,s);t.target=n.toArray(),this.deleteAll([r,i,s,n])}{const s=this.toVector(this.m_module.Vector3d.kZAxis),r=this.toPoint(t.target),n=this.toPoint(t.position),a=i.rotateBy(e,s),o=r.sub(n),h=o.asVector(),l=h.crossProduct(a),d=l.normalize();t.upVector=d.toArray(),this.deleteAll([s,r,n,a,o,h,l,d])}}drag(t,e,i,s){if(this.press){const i=this.getViewer().activeView,s=i.vportRect,r=Math.max(Math.abs(s[2]-s[0]),Math.abs(s[3]-s[1])),n=(this.m_startPoint.x-t)*Math.PI/r,a=(this.m_startPoint.y-e)*Math.PI/r;this.m_startPoint.x=t,this.m_startPoint.y=e;const o=a,h=n,l={position:i.viewPosition,target:i.viewTarget,upVector:i.upVector,viewFieldWidth:i.viewFieldWidth,viewFieldHeight:i.viewFieldHeight,perspective:i.perspective};i.delete();const d=this.getSideVector(l);0!=o&&this.calculateXOrbit(l,-o,d),0!=h&&this.calculateYOrbit(l,h,d),d.delete();const c=this.getViewer().getActiveTvExtendedView();c.setView(l.position,l.target,l.upVector,l.viewFieldWidth,l.viewFieldHeight,l.perspective),c.delete()}}end(t,e){this.press=!1,this.endInteractivity()}mouseleave(t){this.end()}getCenter(){const t=this.getViewer();let e=t.getActiveExtents();const i=t.getSelected();if(!i.isNull()&&0!==i.numItems()){const t=i.getIterator(),s=t.getEntity();if(1===s.getType()){const t=s.openObject();e.delete(),e=t.getExtents(),t.delete()}else if(2===s.getType()){const t=s.openObjectAsInsert(),i=t.getExtents();e.delete(),e=i.ext,i.delete(),t.delete()}t.delete()}i.delete();const s=e.center();return e.delete(),s}}class I extends A{constructor(...t){super(...t),this.press=!1,this.getViewer().setEnableAutoSelect(!0)}start(t,e){this.press=!0,this.pressX=t,this.pressY=e}drag(t,e,i,s){if(this.press){const t=.025;this.m_module.getViewer().zoomAt(s>0?1+t:1-t,this.pressX,this.pressY),this.subject.activeDragger()&&this.subject.activeDragger().updatePreview&&this.subject.activeDragger().updatePreview()}}end(t,e){this.press=!1}mouseleave(t){this.end()}}class D{constructor(){this.m_start=[0,0,0],this.m_end=[0,0,0],this.m_model=null}createPoint3d(){return new this.m_module.Point3d}init(t,e){this.m_module=t,this.m_model=e}getViewer(){return this.m_module.getViewer()}setValue(t){this.m_end=t,this.draw()}setStartPoint(t){this.m_start=t,this.m_end=t,this.draw()}toDoubleArray(t){const e=[];for(let i=0;i<t.length;i++)e.push(t[i].x),e.push(t[i].y),e.push(t[i].z);return e}draw(){const t=this.getViewer().activeView,e=t.viewingMatrix,i=[];i.push(this.m_start),i.push(this.createPoint3d()),i.push(this.m_end),i.push(this.createPoint3d());let s=this.createPoint3d();s.set(this.m_start.x,this.m_start.y,this.m_start.z);let r=this.createPoint3d();r.set(this.m_end.x,this.m_end.y,this.m_end.z),s.transformBy(e),r.transformBy(e),i[1].x=s.x,i[3].x=r.x,i[1].y=r.y,i[3].y=s.y,i[1].z=i[3].z=r.z;const n=t.eyeToWorldMatrix;if(i[1].transformBy(n),i[3].transformBy(n),this.m_entity)this.m_frame.openAsPolygon().setPoints(this.toDoubleArray(i));else{this.m_entity=this.m_model.appendEntity("");const t=this.m_entity.openObject();t.setColor(112,112,112),t.setLineWeight(2),this.m_frame=t.appendPolygon(this.toDoubleArray(i)),t.delete()}}clear(){this.m_entity&&(this.m_model.removeEntity(this.m_entity),this.m_entity=null)}}class C extends A{constructor(...t){super(...t),this.press=!1,this.needInputText=!1,this.m_frame=new D,this.getViewer().setEnableAutoSelect(!0),this.m_frame.init(this.m_module,this.getModel())}start(t,e){this.press=!0,this.m_minX=t,this.m_minY=e;const i=this.screenToWorld(t,e);this.m_frame.setStartPoint(i)}drag(t,e,i,s){if(this.press){this.m_maxX=t,this.m_maxY=e;const i=this.screenToWorld(t,e);this.m_frame.setValue(i)}}end(t,e){this.press=!1,this.m_maxX=t,this.m_maxY=e,this.m_minX!==this.m_maxX&&this.m_minY!==this.m_maxY&&(this.m_frame.clear(),this.getViewer().zoomWindow(this.m_minX,this.m_minY,this.m_maxX,this.m_maxY))}}class k extends A{constructor(...t){super(...t),this.press=!1,this.maxPolarAngle=Math.PI/2,this.minPolarAngle=0,this.getViewer().setEnableAutoSelect(!0)}start(t,e){this.press=!0,this.m_viewCenter=this.getCenter(),this.m_startPoint={x:t,y:e};const i=this.getViewer().activeView;this.startCameraParams=this.getViewParams();const s=i.vportRect;this.m_delta=Math.max(s[1]-s[0],s[2]-s[3]),this.beginInteractivity()}setDefaultViewParams(){this.setViewParams(this.startCameraParams)}drag(t,e,i,s){if(this.press){let i=t-this.m_startPoint.x,s=e-this.m_startPoint.y;i*=Math.PI/this.m_delta,s*=Math.PI/this.m_delta,this.setDefaultViewParams();const{Vector3d:r,Matrix3d:n}=this.m_module,a=r.createFromArray(this.startCameraParams.target),o=r.createFromArray(this.startCameraParams.position).sub(a),h=o.normalize(),l=new n;l.setToIdentity();const d=new n;d.setToIdentity();const c=r.createFromArray([h.x,h.y,h.z]),m=r.createFromArray(this.startCameraParams.upVector),u=c.crossProduct(m);let p=r.createFromArray([c.x,c.y,0]);p.length()<=1e-5?p.set(-u.y,u.x,0):p=p.normalize();i-=Math.sign(p.dotProduct(r.createFromArray([-1,0,0])))*p.angleTo(r.createFromArray([0,1,0]));let g=r.createFromArray([h.x,h.y,0]),w=0;g.length()<=1e-5?w=-h.z*Math.PI/2:(g=g.normalize(),w=-g.angleTo(h)),s-=w,l.setToRotation(-i,[0,0,1],[0,0,0]);const v=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,s));d.setToRotation(v,[1,0,0],[0,0,0]);const y=l.postMultBy(d);let _=r.createFromArray([0,1,0]).transformBy(y);const f=r.createFromArray([0,0,1]).transformBy(y);_.setLength(o.length()),_=a.add(_);const P=this.getViewParams();P.position=_.toArray(),P.upVector=f.toArray(),this.setViewParams(P)}}end(t,e){this.press=!1,this.endInteractivity()}mouseleave(t){this.end()}getCenter(){const t=this.getViewer();let e=t.getActiveExtents();const i=t.getSelected();if(!i.isNull()&&0!==i.numItems()){const t=i.getIterator(),s=t.getEntity();if(1===s.getType()){const t=s.openObject();e.delete(),e=t.getExtents(),t.delete()}else if(2===s.getType()){const t=s.openObjectAsInsert(),i=t.getExtents();e.delete(),e=i.ext,i.delete(),t.delete()}t.delete()}i.delete();const s=e.center();return e.delete(),s}}class M extends A{constructor(...t){super(...t),this.subject.eventEmitter.removeDragger(this),this.subject.eventEmitter.addDragger(this,["wheel"])}wheel(t){t=t||window.event;const e=Math.sign(t.deltaY),i=this.m_module.getViewer();if(i){const s=.075*e,{Vector3d:r}=this.m_module,n=this.getViewParams(),a=r.createFromArray([.5*this.m_module.canvas.clientWidth,.5*this.m_module.canvas.clientHeight,0]),o=r.createFromArray([t.offsetX,t.offsetY,0]),h=o.sub(a);n.viewFieldWidth=n.viewFieldWidth*(1+s),n.viewFieldHeight=n.viewFieldHeight*(1+s),this.setViewParams(n),s<0&&i.pan(h.x*s,h.y*s),this.subject.activeDragger()&&this.subject.activeDragger().updatePreview&&this.subject.activeDragger().updatePreview(),a.delete(),o.delete(),h.delete()}}}function T(t,e){return t||(t=document.createElement("div"),e.appendChild(t)),t}function O(t,e){return t&&e.removeChild(t),null}function L(t,e,i){const s=e.Point3d.createFromArray(t),r=i.activeView,n=r.worldToDeviceMatrix,a=s.transformBy(n),o={x:a.x/window.devicePixelRatio,y:a.y/window.devicePixelRatio};return n.delete(),s.delete(),a.delete(),r.delete(),o}function R(t){return t<0?Math.ceil(t):Math.floor(t)}function $(t,e,i,s,r){const n=((t,e,i,s)=>{const r=e.x-t.x,n=e.y-t.y,a=s.x-i.x,o=s.y-i.y,h=(-n*(t.x-i.x)+r*(t.y-i.y))/(-a*n+r*o),l=(+a*(t.y-i.y)-o*(t.x-i.x))/(-a*n+r*o);return h>=0&&h<=1&&l>=0&&l<=1&&{x:R(t.x+l*r),y:R(t.y+l*n)}})(t,e,i,s);n&&r.push(n)}function W(t,e,i){return t.x<=e&&t.x>=0&&t.y<=i&&t.y>=0}function j(t,e){t&&(t.onclick=e?()=>e(this):()=>{})}function J(t,e){t.style.pointerEvents=e?"auto":"none"}class B{constructor(t,e,i){this.htmlElemStartPoint=null,this.htmlElemEndPoint=null,this.htmlElemLine=null,this.htmlElemTitle=null,this.startPoint=null,this.endPoint=null,this.unit="",this.scale=1,this.size=10,this.lineThickness=2,this.style={border:"2px solid #FFFFFF",background:"#009bff",color:"white",boxShadow:"0 0 10px rgba(0,0,0,0.5)"},this.htmlElemStartPoint=T(this.htmlElemStartPoint,t),this.htmlElemEndPoint=T(this.htmlElemEndPoint,t),this.htmlElemLine=T(this.htmlElemLine,t),this.htmlElemTitle=T(this.htmlElemTitle,t),this.viewer=e,this.moduleInstance=i,this.targetElement=t,this.isFinishDraw=!1}drawMeasureLine(){const t=this.size,e=this.moduleInstance.canvas.getBoundingClientRect();if(this.startPoint){this.htmlElemStartPoint=T(this.htmlElemStartPoint,this.targetElement);const i=L(this.startPoint,this.moduleInstance,this.viewer);W(i,e.width,e.height)?(this.htmlElemStartPoint.style.display="block",this.htmlElemStartPoint.style.cursor="pointer",this.htmlElemStartPoint.style.position="absolute",this.htmlElemStartPoint.style.top=i.y-t/2+"px",this.htmlElemStartPoint.style.left=i.x-t/2+"px",this.htmlElemStartPoint.style.borderRadius=`${t}px`,this.htmlElemStartPoint.style.border=this.style.border,this.htmlElemStartPoint.style.background=this.style.background,this.htmlElemStartPoint.style.zIndex=2,this.htmlElemStartPoint.style.width=`${t}px`,this.htmlElemStartPoint.style.height=`${t}px`,this.htmlElemStartPoint.style.boxShadow=this.style.boxShadow):this.htmlElemStartPoint.style.display="none"}if(this.endPoint&&this.isFinishDraw){this.htmlElemEndPoint=T(this.htmlElemEndPoint,this.targetElement);const i=L(this.endPoint,this.moduleInstance,this.viewer);W(i,e.width,e.height)?(this.htmlElemEndPoint.style.display="block",this.htmlElemEndPoint.style.cursor="pointer",this.htmlElemEndPoint.style.position="absolute",this.htmlElemEndPoint.style.top=i.y-t/2+"px",this.htmlElemEndPoint.style.left=i.x-t/2+"px",this.htmlElemEndPoint.style.borderRadius=`${t}px`,this.htmlElemEndPoint.style.border=this.style.border,this.htmlElemEndPoint.style.background=this.style.background,this.htmlElemEndPoint.style.zIndex=2,this.htmlElemEndPoint.style.width=`${t}px`,this.htmlElemEndPoint.style.height=`${t}px`,this.htmlElemEndPoint.style.boxShadow=this.style.boxShadow):this.htmlElemEndPoint.style.display="none"}if(this.endPoint&&this.startPoint){const t=L(this.startPoint,this.moduleInstance,this.viewer),i=L(this.endPoint,this.moduleInstance,this.viewer),{p1:s,p2:r,angle:n,width:a}=function(t,e,i,s){const r={x:0,y:0},n={x:i,y:0},a={x:0,y:s},o={x:i,y:s},h=[];$(t,e,r,n,h),$(t,e,r,a,h),$(t,e,a,o,h),$(t,e,o,n,h);let l=null,d=null;0===h.length?(l=t,d=e):1===h.length?W(t,i,s)?(l=t,d=h[0]):(l=h[0],d=e):(l=h[0],d=h[1]);const c=d.x-l.x,m=d.y-l.y;let u=180*Math.atan(m/c)/Math.PI;return c<0&&(u-=180),{angle:u,width:Math.sqrt(Math.pow(c,2)+Math.pow(m,2)),p1:l,p2:d}}(t,i,e.width,e.height),o=r.x-s.x,h=r.y-s.y,l=this.lineThickness;if(W(s,e.width,e.height)&&W(r,e.width,e.height)){this.htmlElemLine=T(this.htmlElemLine,this.targetElement),this.htmlElemLine.style.display="block",this.htmlElemLine.style.cursor="pointer",this.htmlElemLine.style.position="absolute",this.htmlElemLine.style.top=`${s.y}px`,this.htmlElemLine.style.left=`${s.x}px`,this.htmlElemLine.style.width=`${a}px`,this.htmlElemLine.style.transform=`rotate(${n}deg)`,this.htmlElemLine.style.transformOrigin=`0px ${l/2}px`,this.htmlElemLine.style.boxShadow=this.style.boxShadow,this.htmlElemLine.style.border="none",this.htmlElemLine.style.background=this.style.background,this.htmlElemLine.style.zIndex=1,this.htmlElemLine.style.height=`${l}px`;const t=`${this.getDistance()} ${this.unit}`,e=s.x+o/2,i=s.y+h/2,r=10*t.length;this.htmlElemTitle=T(this.htmlElemTitle,this.targetElement),this.htmlElemTitle.style.display="block",this.htmlElemTitle.style.cursor="pointer",this.htmlElemTitle.style.font="10px",this.htmlElemTitle.style.color="white",this.htmlElemTitle.style.position="Absolute",this.htmlElemTitle.style.top=`${i}px`,this.htmlElemTitle.style.left=e-r/2+"px",this.htmlElemTitle.style.width=`${r}px`,this.htmlElemTitle.style.transformOrigin="0px 0px",this.htmlElemTitle.style.borderRadius="5px",this.htmlElemTitle.style.boxShadow=this.style.boxShadow,this.htmlElemTitle.style.border="none",this.htmlElemTitle.style.background=this.style.background,this.htmlElemTitle.style.zIndex=3,this.htmlElemTitle.style.padding="2px",this.htmlElemTitle.style.textAlign="center",this.htmlElemTitle.innerHTML=`${t}`}else this.htmlElemLine.style.display="none",this.htmlElemTitle.style.display="none"}}getDistance(){return function(t,e,i){const s=i.Point3d.createFromArray(t),r=i.Point3d.createFromArray(e),n=s.distanceTo(r).toFixed(2);return s.delete(),r.delete(),n}(this.startPoint,this.endPoint,this.moduleInstance)/this.scale}setStartPoint(t){this.startPoint=t,this.drawMeasureLine()}setEndPoint(t,e){this.isFinishDraw=void 0===e||e,this.endPoint=t,this.drawMeasureLine()}update(){this.drawMeasureLine()}setSize(t){this.size=t,this.drawMeasureLine()}clear(){this.endPoint=null,this.startPoint=null,this.htmlElemStartPoint=O(this.htmlElemStartPoint,this.targetElement),this.htmlElemEndPoint=O(this.htmlElemEndPoint,this.targetElement),this.htmlElemLine=O(this.htmlElemLine,this.targetElement),this.htmlElemTitle=O(this.htmlElemTitle,this.targetElement)}setUnit(t){this.unit=t,this.drawMeasureLine()}setConversionFactor(t){this.scale=t,this.drawMeasureLine()}setStyle(t){this.style=t,this.drawMeasureLine()}setSelectionReactor(t){j(this.htmlElemStartPoint,t?t.onStartPoint:null),j(this.htmlElemEndPoint,t?t.onEndPoint:null),j(this.htmlElemTitle,t?t.onTitle:null)}setSelectability(t){J(this.htmlElemStartPoint,t),J(this.htmlElemEndPoint,t),J(this.htmlElemLine,t),J(this.htmlElemTitle,t)}}class U extends A{constructor(...t){super(...t),this.lineThickness=2,this.press=!1,this.autoSelect=!1,this.gripingRadius=5,this.firstPoint=null,this.secondPoint=null,this.m_overlayElement=document.createElement("div"),this.m_overlayElement.style.background="rgba(0,0,0,0)",this.m_overlayElement.style.position="fixed",this.m_overlayElement.style.zIndex="1",this.m_overlayElement.style.pointerEvents="none",document.body.appendChild(this.m_overlayElement),this.renameUnitTable={Millimeters:"mm",Centimeters:"cm",Meters:"m",Undefined:" "},this.items=[],this.resize(),this._resize=()=>this.resize(),window.addEventListener("resize",this._resize)}dispose(){window.removeEventListener("resize",this._resize),super.dispose(),this.m_overlayElement.remove()}updatePreview(){for(let t of this.items)t.update()}resize(t){const e=this.m_module.canvas.getBoundingClientRect();this.m_overlayElement.style.top=`${e.top}px`,this.m_overlayElement.style.left=`${e.left}px`,this.m_overlayElement.style.width=`${e.width}px`,this.m_overlayElement.style.height=`${e.height}px`}getSnapPointRadius(){const t=this.getViewer().activeView.viewDcCorners(),e=t.lowerLeft,i=t.upperRight;return i[0]-=e[0],i[1]-=e[1],Math.min(i[0],i[1])/120}drag(t,e){this.createNewMeasureIfNeed();const i=this.getViewer().getSnapPoint(t,e,this.gripingRadius);this.isDragging?i?this.firstPoint?(this.secondPoint=i,this.previewMeasureLine.setStartPoint(this.firstPoint),this.previewMeasureLine.setEndPoint(this.secondPoint)):(this.firstPoint=i,this.previewMeasureLine.setStartPoint(this.firstPoint)):(this.secondPoint=null,this.previewMeasureLine.clear(),this.previewMeasureLine.setStartPoint(this.firstPoint),this.previewMeasureLine.setEndPoint(this.getViewer().screenToWorld(t,e),!1)):i?this.previewMeasureLine.setStartPoint(i):this.previewMeasureLine.clear()}end(){if(this.firstPoint&&this.secondPoint){const t=this.createMeasureLine();t.setStartPoint(this.firstPoint),t.setEndPoint(this.secondPoint)}this.firstPoint=this.secondPoint=null,this.previewMeasureLine.clear()}createNewMeasureIfNeed(){this.previewMeasureLine||(this.previewMeasureLine=this.createMeasureLine())}createMeasureLine(){const t=this.m_module.getViewer();var e,i,s=new B(this.m_overlayElement,t,this.m_module);return s.lineThickness=this.lineThickness||s.lineThickness,s.setUnit((e=this.renameUnitTable,i=t.getUnit(),e[i]||i)),this.items.push(s),s}}class N extends A{constructor(...t){super(...t),this.press=!1,this.getViewer().setEnableAutoSelect(!1);const e=this.getViewer().getActiveExtents(),i=e.min(),s=e.max();this.m_size_x=Math.abs(s[0]-i[0])/2,this.m_size_y=Math.abs(s[1]-i[1])/2,this.m_size_z=Math.abs(s[2]-i[2])/2,this.m_center=this.toPoint(e.center()),this.m_normal=this.createNormal();const r=this.getViewer().activeView,n=this.createPlane();n.set(this.toGePoint(this.m_center),this.m_normal),r.addCuttingPlane(n),this.index=r.numCuttingPlanes()-1,r.setEnableCuttingPlaneFill(!0,102,102,102),this.m_model=this.getModel(),this.createPreview(),this.deleteAll([e,r,n])}dispose(){super.dispose(),this.m_entity&&(this.m_model.removeEntity(this.m_entity),this.deleteAll([this.m_model,this.m_entity,this.planePreview]),this.m_entity=null,this.planePreview=null)}createNormal(){return[0,0,0]}handleDelta(t){return t}getPlanePreviewCoordinate(){return[]}start(t,e){this.press=!0,this.m_last=this.screenToWorld(t,e),this.m_click={x:t,y:e}}drag(t,e){if(this.press){const i=this.screenToWorld(t,e),s=this.handleDelta(i.sub(this.m_last)),r=this.m_center;this.m_center=r.add(s);const n=this.m_last;this.m_last=i;const a=this.getViewer().activeView,o=this.createPlane(),h=o.set(this.toGePoint(this.m_center),this.m_normal),l=a.updateCuttingPlane(this.index,o);this.drawPreview(),this.deleteAll([a,o,r,s,n,h,l])}}end(t,e){if(this.press=!1,t===this.m_click.x&&e===this.m_click.y){this.m_normal=[-1*this.m_normal[0],-1*this.m_normal[1],-1*this.m_normal[2]];const t=this.getViewer().activeView,e=this.createPlane();e.set(this.toGePoint(this.m_center),this.m_normal),t.updateCuttingPlane(this.index,e),this.deleteAll([t,e,this.m_center,this.m_last])}}createPreview(){this.m_entity=this.m_model.appendEntity("&CuttingPlanePreview");const t=this.m_module.GeometryTypes,e=new this.m_module.OdTvTransparencyDef,i=new this.m_module.OdTvColorDef(112,112,112);e.setValue(.9);const s=this.m_entity.openObject();s.setColor(i,t.kFaces.value),i.setColor(112,112,112),s.setColor(i,t.kEdges.value),s.setLineWeight(5),s.setTransparency(e,t.kFaces),e.setValue(1),s.setTransparency(e,t.kEdges),this.planePreview=s.appendPolygon(this.getPlanePreviewCoordinate());const r=this.planePreview.openAsPolygon();r.setFilled(!0),this.deleteAll([e,i,s,r,t])}drawPreview(){const t=this.planePreview.openAsPolygon();t.setPoints(this.getPlanePreviewCoordinate()),this.deleteAll([t])}}class H extends N{createNormal(){return[1,0,0]}handleDelta(t){return t.y=0,t.z=0,t}getPlanePreviewCoordinate(){return[this.m_center.x,this.m_center.y-this.m_size_y,this.m_center.z-this.m_size_z,this.m_center.x,this.m_center.y+this.m_size_y,this.m_center.z-this.m_size_z,this.m_center.x,this.m_center.y+this.m_size_y,this.m_center.z+this.m_size_z,this.m_center.x,this.m_center.y-this.m_size_y,this.m_center.z+this.m_size_z]}}class X extends N{createNormal(){return[0,1,0]}handleDelta(t){return t.x=0,t.z=0,t}getPlanePreviewCoordinate(){return[this.m_center.x-this.m_size_x,this.m_center.y,this.m_center.z-this.m_size_z,this.m_center.x+this.m_size_x,this.m_center.y,this.m_center.z-this.m_size_z,this.m_center.x+this.m_size_x,this.m_center.y,this.m_center.z+this.m_size_z,this.m_center.x-this.m_size_x,this.m_center.y,this.m_center.z+this.m_size_z]}}class Y extends N{createNormal(){return[0,0,1]}handleDelta(t){return t.x=0,t.y=0,t}getPlanePreviewCoordinate(){return[this.m_center.x-this.m_size_x,this.m_center.y-this.m_size_y,this.m_center.z,this.m_center.x+this.m_size_x,this.m_center.y-this.m_size_y,this.m_center.z,this.m_center.x+this.m_size_x,this.m_center.y+this.m_size_y,this.m_center.z,this.m_center.x-this.m_size_x,this.m_center.y+this.m_size_y,this.m_center.z]}}class Z extends A{constructor(...t){super(...t),this.press=!1,this.getViewer().setEnableAutoSelect(!1)}dispose(){super.dispose(),this.end(),this.points=null,this.drawPoints=null}start(t,e){const i=this.getViewer().screenToWorld(t,e);this.drawPoints=[i[0],i[1],i[2]]}drag(t,e){if(this.isDragging){const i=this.getViewer().screenToWorld(t,e);this.drawPoints.push(i[0],i[1],i[2]),this._updateFrame()}}end(){this.entity&&(this.entity.delete(),this.drawPoints=null,this.entity=null)}_updateFrame(){if(this.entity){const t=this.getViewer().getMarkupModel();t.removeEntity(this.entity),t.delete(),this.entity.delete()}this.entity=this.getActiveMarkupEntity("Line");const t=this.entity.openObject();t.appendPolyline(this.drawPoints).delete(),t.delete()}}class G extends A{constructor(...t){super(...t),this.press=!1,this.getViewer().setEnableAutoSelect(!1)}dispose(){super.dispose(),this.textRef&&this.textRef.remove(),this.textRef=null}_finishInput(){this._updateFrame(),this.textRef&&this.textRef.remove(),this.textRef=null}start(t,e,i,s){this.textRef?this._finishInput():(this.textRef=document.createElement("textarea"),this.textRef.style.zIndex=9999,this.textRef.style.position="absolute",this.textRef.style.display="block",this.textRef.style.top=s+"px",this.textRef.style.left=i+"px",this.textRef.onkeypress=t=>{"Enter"===t.key&&(t.preventDefault(),this._finishInput())},document.body.appendChild(this.textRef),this.press=!0,this.m_data=null,this.m_center=this.screenToWorld(t,e+24),this.needInputText=!0)}_updateFrame(){this.entity=this.getActiveMarkupEntity("Text");const t=this.entity.openObject(),e=this.getViewer().activeView,i=this.toPoint(e.viewPosition),s=this.toPoint(e.viewTarget),r=e.eyeToWorldMatrix,n=i.sub(s).asVector(),a=this.toVector([1,0,0]).transformBy(r),o=this.createMatrix3d();o.setToWorldToPlane(this.toGeVector(n)),a.transformBy(o);let h=-Math.atan2(-a.y,a.x),l=1;const d=e.projectionMatrix.get(1,1),c=1e-6;d<c&&d>-c||(l=1/d);const m=t.appendText(this.toGePoint(this.m_center),this.textRef.value.trimLeft()),u=m.openAsText();u.setNormal(this.toGeVector(n)),u.setRotation(h),u.setTextSize(.02*l),u.delete(),m.delete(),t.delete()}}const K=(t,e,i)=>t/42*Math.sqrt(e*e+i*i);class q extends A{constructor(...t){super(...t),this.press=!1,this.getViewer().setEnableAutoSelect(!1),this.lastCoord={x:0,y:0},this.speed=1,this.delta=this.getViewer().activeView.viewFieldWidth/1e3,this.keyPressMap=new Set,this.onKeyDown=t=>{const e=this.speed*this.delta;this.keyPressMap.add(t.code);for(let t of this.keyPressMap)"KeyW"===t?this.cameraWalker.moveForward(e):"KeyS"===t?this.cameraWalker.moveBackward(e):"KeyA"===t?this.cameraWalker.moveLeft(e):"KeyD"===t?this.cameraWalker.moveRight(e):"KeyQ"===t?this.cameraWalker.moveUp(e):"KeyE"===t?this.cameraWalker.moveDown(e):"NumpadSubtract"===t||"Minus"===t?(this.speed=1!==this.speed?this.speed-1:1,this.subject.emitEvent({type:"ChangeWalkDraggerSpeed",data:this.speed})):"NumpadAdd"!==t&&"Equal"!==t||(this.speed=10!==this.speed?this.speed+1:10,this.subject.emitEvent({type:"ChangeWalkDraggerSpeed",data:this.speed}))},this.onKeyRelease=t=>{this.keyPressMap.delete(t.code)},window.addEventListener("keydown",this.onKeyDown,!1),window.addEventListener("keyup",this.onKeyRelease,!1),this.cameraId||this.initialize(),this.subject._setEnableForZoomWheelDragger(!1)}initialize(){const t=this.getViewer().activeView;this.subject.emitEvent({type:"StartWalkerDragger",data:null}),this.viewParams={position:t.viewPosition,target:t.viewTarget,upVector:t.upVector,viewFieldWidth:t.viewFieldWidth,viewFieldHeight:t.viewFieldHeight,perspective:t.perspective,lensLength:t.lensLength};const e=this.getViewer().getActiveTvExtendedView();e.setView(this.viewParams.position,this.viewParams.target,this.viewParams.upVector,this.viewParams.viewFieldWidth,this.viewParams.viewFieldHeight,!0),e.delete(),t.lensLength=42*t.lensLength/120;const i=this.getViewer().getActiveModel();this.cameraId=i.appendCamera("Camera0");const s=this.cameraId.openObjectAsCamera();var r=t.viewTarget;s.setDisplayGlyph(!1),s.setDisplayTarget(!1),s.setAutoAdjust(!0),s.setupCamera(t.viewPosition,r,t.upVector),s.setNearClip(!1,1),s.setFarClip(!1,0),s.setViewParameters(t.viewFieldWidth,t.viewFieldHeight,!0);const n=K(t.lensLength,t.viewFieldWidth,t.viewFieldHeight);{const e=this.toPoint(t.viewTarget),i=this.toPoint(t.viewPosition),r=i.sub(e),a=r.asVector(),o=a.normalize(),h=this.toGeVector(o),l=[h[0]*n,h[1]*n,h[2]*n],d=this.toPoint(t.viewTarget),c=this.toPoint(l),m=d.add(c);s.setupCamera(this.toGePoint(m),t.viewTarget,t.upVector),this.deleteAll([e,i,r,a,o,d,c,m])}s.assignView(t),s.delete(),i.delete(),this.cameraWalker=new this.m_module.OdTvCameraWalker,this.cameraWalker.setCamera(this.cameraId)}dispose(){if(super.dispose(),this.keyPressMap.clear(),window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyRelease),this.cameraId){const t=this.getViewer().getActiveModel();t.removeEntity(this.cameraId),t.delete(),this.cameraWalker&&this.cameraWalker.delete()}if(this.viewParams){const t=this.getViewer().getActiveTvExtendedView();t.setView(this.viewParams.position,this.viewParams.target,this.viewParams.upVector,this.viewParams.viewFieldWidth,this.viewParams.viewFieldHeight,this.viewParams.perspective),t.delete();const e=this.getViewer().activeView;e.lensLength=this.viewParams.lensLength,e.delete()}this.subject._setEnableForZoomWheelDragger(!0)}drag(t,e,i,s){const r=this.getViewer().activeView,n=K(r.lensLength,r.viewFieldWidth,r.viewFieldHeight),a=2*Math.atan(r.viewFieldHeight/(2*n)),o=2*Math.atan(r.viewFieldWidth/(2*n)),h=Math.abs(s)*a/this.m_module.canvas.height*this.subject.api.options.cameraAxisYSpeed,l=Math.abs(i)*o/this.m_module.canvas.width*this.subject.api.options.cameraAxisXSpeed;this.cameraId&&this.isDragging&&(0!==i&&(i>0?this.cameraWalker.turn(this.viewParams.upVector,-l):i<0&&this.cameraWalker.turn(this.viewParams.upVector,l)),0!==s&&(s<0?this.cameraWalker.turnUp(h):s>0&&this.cameraWalker.turnDown(h)))}}function Q(t){const e=t.getViewer(),i=e.getActiveDevice(),s=i.getActiveView();s.enableDefaultLighting(!0,t.DefaultLightingType.kTwoLights),s.setDefaultLightingIntensity(1.25);const r=e.createVisualStyle("OpenCloud");{const i=r.openObject(),s=new t.OdTvColorDef(66,66,66),n=e.findVisualStyle("Realistic");i.copyFrom(n),i.setOptionInt32(t.VisualStyleOptions.kFaceModifiers,0,t.VisualStyleOperations.kSet),i.setOptionInt32(t.VisualStyleOptions.kEdgeModel,2,t.VisualStyleOperations.kSet),i.setOptionDouble(t.VisualStyleOptions.kEdgeCreaseAngle,60,t.VisualStyleOperations.kSet),i.setOptionInt32(t.VisualStyleOptions.kEdgeStyles,0,t.VisualStyleOperations.kSet),i.setOptionInt32(t.VisualStyleOptions.kEdgeModifiers,8,t.VisualStyleOperations.kSet),i.setOptionColor(t.VisualStyleOptions.kEdgeColorValue,s,t.VisualStyleOperations.kSet),i.delete()}s.visualStyle=r,s.delete(),i.delete()}class tt{constructor(t){this.api=t,this._changeClientOptionCb=t=>{const e=t.data;this.syncOptions(e)},this.api.eventEmitter.on("changeClientOption",this._changeClientOptionCb),this.opt={visualizeJsUrl:"https://opencloud.azureedge.net/libs/visualizejs/23.1/Visualize.js"},this._activeDragger=null,this.visualizeJs=null,this.eventEmitter=new E,this.draggerFactory=new Map,this.draggerFactory.set("Line",Z),this.draggerFactory.set("Text",G),this.draggerFactory.set("Pan",F),this.draggerFactory.set("Orbit",z),this.draggerFactory.set("Zoom",I),this.draggerFactory.set("ZoomWindow",C),this.draggerFactory.set("OrbitAroundBuilding",k),this.draggerFactory.set("MeasureLine",U),this.draggerFactory.set("CuttingPlaneXAxis",H),this.draggerFactory.set("CuttingPlaneYAxis",X),this.draggerFactory.set("CuttingPlaneZAxis",Y),this.draggerFactory.set("Walk",q),this.render=()=>{this.frameId=requestAnimationFrame(this.render),this.visViewer().update()}}syncOptions(t){const e=this.visViewer();if(e){if(t.showFPS!==e.getEnableFPS()&&e.setEnableFPS(t.showFPS),t.showWCS!==e.getEnableWCS()&&e.setEnableWCS(t.showWCS),t.cameraAnimation!==e.getEnableAnimation()&&e.setEnableAnimation(t.cameraAnimation),t.antialiasing!==e.fxaaAntiAliasing3d&&(e.fxaaAntiAliasing3d=t.antialiasing,e.fxaaQuality=5),t.groundShadow!==e.groundShadow&&(e.groundShadow=t.groundShadow),t.shadows!==e.shadows){e.shadows=t.shadows;const i=this.visLib().canvas,s=e.getActiveDevice();s.invalidate([0,i.clientWidth,i.clientHeight,0]),s.delete()}const i=this.visLib(),s=e.getActiveDevice();if(t.ambientOcclusion!==s.getOptionBool(i.DeviceOptions.kSSAOEnable)){s.setOptionBool(i.DeviceOptions.kSSAOEnable,t.ambientOcclusion),s.setOptionBool(i.DeviceOptions.kSSAODynamicRadius,!0),s.setOptionDouble(i.DeviceOptions.kSSAORadius,1),s.setOptionInt32(i.DeviceOptions.kSSAOLoops,32),s.setOptionDouble(i.DeviceOptions.kSSAOPower,2),s.setOptionInt32(i.DeviceOptions.kSSAOBlurRadius,2);const r=e.activeView;r.setSSAOEnabled(t.ambientOcclusion),r.delete()}s.delete()}}_setEnableForZoomWheelDragger(t){t&&!this.wheelZoomDragger?this.wheelZoomDragger=new M(this):(this.wheelZoomDragger&&this.wheelZoomDragger.dispose(),this.wheelZoomDragger=null)}configure(t){return this.opt=t,this}initializeAsync(t,e=null){return""===t.style.width&&""===t.style.height&&(t.style.width="100%",t.style.height="100%"),x(this.opt.visualizeJsUrl,(t=>{const{loaded:i,timeStamp:s,total:r,lengthComputable:n}=t;e&&e({loaded:i,timeStamp:s,total:r,lengthComputable:n,type:"visualize-progress"})})).then((t=>this.visualizeJs=t)).then((()=>{t.width=t.clientWidth*window.devicePixelRatio,t.height=t.clientHeight*window.devicePixelRatio,this.visualizeJs.canvas=t,this.visualizeJs.Viewer.create()})).then((()=>{this.syncOptions(this.api.options),this.eventEmitter.attach(this.visualizeJs.canvas,"mousemove"),this.eventEmitter.attach(this.visualizeJs.canvas,"mousedown"),this.eventEmitter.attach(this.visualizeJs.canvas,"mouseup"),this.eventEmitter.attach(this.visualizeJs.canvas,"mouseleave"),this.eventEmitter.attach(this.visualizeJs.canvas,"click"),this.eventEmitter.attach(this.visualizeJs.canvas,"touchstart"),this.eventEmitter.attach(this.visualizeJs.canvas,"touchend"),this.eventEmitter.attach(this.visualizeJs.canvas,"touchcancel"),this.eventEmitter.attach(this.visualizeJs.canvas,"touchmove"),this.eventEmitter.attach(this.visualizeJs.canvas,"dblclick"),this.eventEmitter.attach(this.visualizeJs.canvas,"wheel"),this.eventEmitter.attach(window,"resize"),this.wheelZoomDragger=new M(this),this.eventEmitter.addEventListener("resize",(e=>{const{clientWidth:i,clientHeight:s}=t;t.height=s*window.devicePixelRatio,t.width=i*window.devicePixelRatio,this.visViewer().resize(0,t.width,t.height,0),this.activeDragger()&&this.activeDragger().updatePreview&&this.activeDragger().updatePreview()}))})).then((()=>this.render())).then((()=>Promise.resolve(this)))}get draggers(){return[...this.draggerFactory.keys()]}activeDragger(){return this._activeDragger}setActiveDragger(t){const e=this.draggerFactory.get(t);this._activeDragger instanceof e||(this._activeDragger&&this._activeDragger.dispose(),this._activeDragger=null,this._activeDragger=new e(this))}visLib(){return this.visualizeJs}visViewer(){return this.visualizeJs.getViewer()}clearSlices(){const t=this.visViewer().activeView;t.removeCuttingPlanes(),t.delete()}clearOverlay(){const t=this.visViewer().getMarkupController();t.clear(),t.delete()}is3D(){const t=this.visViewer().getActiveExtents(),e=t.min();return 0!==t.max()[2]-e[2]}dispose(){this.visLib()&&(this.activeDragger()&&this.activeDragger().dispose(),this.visViewer().clear()),cancelAnimationFrame(this.frameId),this.eventEmitter.detach(this.visualizeJs.canvas,"mousemove"),this.eventEmitter.detach(this.visualizeJs.canvas,"mousedown"),this.eventEmitter.detach(this.visualizeJs.canvas,"mouseup"),this.eventEmitter.detach(this.visualizeJs.canvas,"mouseleave"),this.eventEmitter.detach(this.visualizeJs.canvas,"click"),this.eventEmitter.detach(this.visualizeJs.canvas,"touchstart"),this.eventEmitter.detach(this.visualizeJs.canvas,"touchend"),this.eventEmitter.detach(this.visualizeJs.canvas,"touchcancel"),this.eventEmitter.detach(this.visualizeJs.canvas,"touchmove"),this.eventEmitter.detach(this.visualizeJs.canvas,"dblclick"),this.eventEmitter.detach(this.visualizeJs.canvas,"wheel"),this.eventEmitter.detach(window,"resize"),this.eventEmitter.removeEventListener(),this.wheelZoomDragger.dispose(),this._abortController&&this._abortController.abort(),this.api.eventEmitter.remove("changeClientOption",this._changeClientOptionCb)}addEventListener(t,e){this.eventEmitter.addEventListener(t,e)}removeEventListener(t,e){this.eventEmitter.removeEventListener(t,e)}emitEvent(t){this.eventEmitter.emitEvent(t)}getSelected(){const t=[],e=this.visViewer().getSelected();if(!e.isNull()){const i=e.getIterator();for(;!i.done();){const e=i.getEntity(),s=e.openObject(),r=s.getNativeDatabaseHandle();t.push(r),s.delete(),e.delete(),i.step()}i.delete()}return e.delete(),t}async loadReferences(t){let e=[];try{e=(await t.getReferences()).references}catch{}if(!this.visLib())throw new Error("VisualizeJS module is null when try load references");if(!this.visViewer())throw new Error("VisualizeJS module getViewer return null, pls create viewer before load reference");for(let t of e){const e=await this.api.downloadReferenceFile(t.id);this.visViewer().addEmbeddedFile(t.name,new Uint8Array(e))}}async _openTcsStream(t){const e=new AbortController;this._abortController=e;const i=[t.database,...t.geometry],s=i.map((()=>0)),r=(t,e)=>{s[t]=e;const i=s.reduce(((t,e)=>t+e))/(s.length||1);this.emitEvent({type:"geometry-progress",data:i})};this.emitEvent({type:"geometry-start",data:t}),this.visViewer().clear(),this.visViewer().update();try{for(let s=0;s<i.length;s++){const n=i[s],a=await t.downloadResource(n,(t=>r(s,t)),e.signal);e.signal.aborted&&await Promise.reject(new Error(`Open model aborted  ${t.name}`)),this.visViewer().parseStream(new Uint8Array(a)),0==s&&(this.syncOptions(this.api.options),Q(this.visLib())),this.emitEvent({type:0==s?"database-chunk":"geometry-chunk",data:new Uint8Array(a)}),this.visViewer().update()}this.emitEvent({type:"geometry-end",data:t})}catch(t){throw this.emitEvent({type:"error",data:t.message||t}),t}return this}async openVsfxStream(t){const e=new AbortController;this._abortController=e,this.emitEvent({type:"geometry-start",data:t}),this.visViewer().clear(),this.visViewer().update();let i=!1;try{await t.partialDownloadResource(t.database,e.signal,((t,e)=>{const s=this.visViewer().parseVsfx(e);s===this.visLib().DatabaseStreamStatus.ReadyServiceData||s===this.visLib().DatabaseStreamStatus.Complete&&!i?(i=!0,this.syncOptions(this.api.options),Q(this.visLib()),this.emitEvent({type:"database-chunk",data:e})):s===this.visLib().DatabaseStreamStatus.AwaitingObjectsData&&this.emitEvent({type:"geometry-chunk",data:e}),this.emitEvent({type:"geometry-progress",data:t})})),this.emitEvent({type:"geometry-end",data:t})}catch(t){throw this.emitEvent({type:"error",data:t.message||t}),t}return this}async open(t){this.cancel();let e=t;if(t.getModels){e=(await t.getModels()).find((t=>t.default))}0===e.geometry.length&&".vsfx"===e.database.substr(-5)?await this.openVsfxStream(e):await this._openTcsStream(e);{const t=e.assembly,i=this.visLib();if(t){const e=this.visViewer().getModelIterator();for(;!e.done();e.step()){const s=e.getModel(),r=t.getModelTransformMatrix(s.getDatabaseHandle());if(r){const t=s.getExtents(),e=V(r.translate,r.rotation,r.scale,t.center(),new i.Matrix3d);s.setModelingMatrix(e,!0)}}}}}openVsfFile(t){return!t instanceof Uint8Array&&(t=new Uint8Array(t)),this.visViewer().parseFile(t),this.syncOptions(this.api.options),Q(this.visLib()),this}cancel(){return this._abortController&&this._abortController.abort(),this}}class et{constructor(t){this._impl=t}get id(){return this._impl._data.id}get name(){return this._impl._data.name}set name(t){this._impl._data.name=t}get files(){return this._impl._data.files}get owner(){return this._impl._data.owner}get created(){return this._impl._data.created}get status(){return this._impl._data.status}get relatedJobs(){return this._impl._data.relatedJobs}getModelTransformMatrix(t){return this._impl._data.transform[t]}setModelTransformMatrix(t,e){return this._impl._data.transform[t]=e,this._impl._put("",{transform:this._impl._data.transform})}getModels(){return this._impl.getModels().then((t=>t.map((t=>new v(t,null,this)))))}getProperty(t){return this._impl.getProperty(t)}getProperties(){return this._impl.getProperties()}delete(){return this._impl.delete()}downloadResource(t,e,i){return this._impl.downloadResource(t,e,i)}save(){return this._impl.save()}getReferences(){return{fileId:"",references:[]}}}class it{constructor(t){this._showFPS=!1,this._showWCS=!0,this._cameraAnimation=!0,this._antialiasing=!0,this._groundShadow=!1,this._shadows=!1,this._cameraAxisXSpeed=4,this._cameraAxisYSpeed=1,this._ambientOcclusion=!1,this.loadFromStorage(),this._emitter=t}notifierChangeEvent(){this._emitter&&(this.saveToStorage(),this._emitter.emit({type:"changeClientOption",data:this}))}saveToStorage(){const t={showFPS:this._showFPS,showWCS:this._showWCS,cameraAnimation:this._cameraAnimation,antialiasing:this._antialiasing,groundShadow:this._groundShadow,shadows:this._shadows,cameraAxisXSpeed:this._cameraAxisXSpeed,cameraAxisYSpeed:this._cameraAxisYSpeed,ambientOcclusion:this._ambientOcclusion};localStorage.setItem("od-client-settings",JSON.stringify(t))}loadFromStorage(){const t=localStorage.getItem("od-client-settings");if(t){const e=JSON.parse(t);this._showFPS=e.showFPS,this._showWCS=e.showWCS,this._cameraAnimation=e.cameraAnimation,this._antialiasing=e.antialiasing,this._groundShadow=e.groundShadow,this._shadows=e.shadows,this._cameraAxisXSpeed=e.cameraAxisXSpeed||4,this._cameraAxisYSpeed=e.cameraAxisYSpeed||1,this._ambientOcclusion=e.ambientOcclusion||!1}}get showFPS(){return this._showFPS}set showFPS(t){this._showFPS=t,this.notifierChangeEvent()}get showWCS(){return this._showWCS}set showWCS(t){this._showWCS=t,this.notifierChangeEvent()}get cameraAnimation(){return this._cameraAnimation}set cameraAnimation(t){this._cameraAnimation=t,this.notifierChangeEvent()}get antialiasing(){return this._antialiasing}set antialiasing(t){this._antialiasing=t,this.notifierChangeEvent()}get groundShadow(){return this._groundShadow}set groundShadow(t){this._groundShadow=t,this.notifierChangeEvent()}get shadows(){return this._shadows}set shadows(t){this._shadows=t,this.notifierChangeEvent()}set cameraAxisXSpeed(t){this._cameraAxisXSpeed=t,this.notifierChangeEvent()}get cameraAxisXSpeed(){return this._cameraAxisXSpeed}set cameraAxisYSpeed(t){this._cameraAxisYSpeed=t,this.notifierChangeEvent()}get cameraAxisYSpeed(){return this._cameraAxisYSpeed}get ambientOcclusion(){return this._ambientOcclusion}set ambientOcclusion(t){this._ambientOcclusion=t,this.notifierChangeEvent()}}class st{constructor(t){this._url=t.serverUrl,this.user=null,this.eventEmitter=new rt,this.jobUpdater=null,this._options=new it(this.eventEmitter)}get url(){return this._url}get options(){return this._options}createViewer(t){const e=new tt(this);return t.visualizeJsUrl&&e.configure({visualizeJsUrl:t.visualizeJsUrl}),e.initializeAsync(t.target,t.onprogress)}configure(t){return this._url=t.url,this}on(t,e){this.eventEmitter.on(t,e)}removeEventListener(t,e){this.eventEmitter.remove(t,e)}removeAllListeners(){this.eventEmitter.clear()}emit(t){this.eventEmitter.emit(t)}async getFileList(t,e,i,s,r,n){const{allSize:a,limit:o,result:h,size:l}=await this.user.getFiles(t,e,i,s,r,n);return{allSize:a,limit:o,list:h.map((t=>new P(t,this))),size:l,start:t}}async getFile(t){return new P(await this.user.getFile(t),this)}version(){return t(a(`${this._url}/version`,{"Access-Control-Allow-Origin":"*"}))}async signInWithEmail(e,i){const s=btoa(e+":"+i),r=await t(a(`${this._url}/token`,{Authorization:"Basic "+s,"Access-Control-Allow-Origin":"*"}));return this.user=new w(r,this._url,this._options),new _(this.user,this)}setActiveJobUpdater(t){this.jobUpdater&&this.jobUpdater.stop(),this.jobUpdater=new b(this.user,this),t&&this.jobUpdater.start()}getCurrentUser(){return new _(this.user,this)}async loginWithToken(t){return new w({tokenInfo:{token:t}},this._url,this._options).getUserInfo().then((t=>new w(t,this._url,this._options))).then((t=>this.user=t)).then((()=>this))}async uploadFile(t,e={geometry:!0,properties:!1,waitForDone:!1}){const i=await this.user.postFile(t,(t=>this.emit({type:"upload-progress",data:t}))),s=[];e.geometry&&s.push(i.createJob("geometry")),e.properties&&s.push(i.createJob("properties"));const r=await Promise.all(s);return e.waitForDone&&await Promise.all(r.map((t=>t.waitForDone()))),new P(i,this)}deleteFile(t){return this.user.deleteFile(t)}downloadReferenceFile(t,e,i){return this.user.downloadReferenceFile(t,e,i)}getJobs(t=null,e=null,i=null,s=null){return this.user.getJobs(t,e,i,s).then((t=>({...t,result:t.result.map((t=>new f(t,this)))})))}getJob(t){return this.user.getJob(t).then((t=>new f(t,this)))}createJob(t,e){return this.user.postJob(t,e).then((t=>new f(t,this)))}deleteJob(t){return this.user.deleteJob(t)}getProjects(){return this.user.getProjects().then((t=>t.map((t=>new y(t,this)))))}createProject(t,e,i,s,r){return this.user.createProject(t,e,i,s,r).then((t=>new y(t,this)))}getProjectById(t){return this.user.getProjectById(t).then((t=>new y(t,this)))}createAssembly(t,e){return this.user.createAssembly(t,e).then((t=>new et(t)))}getAssemblyById(t){return this.user.getAssemblyById(t).then((t=>new et(t)))}async getAssemblies(t,e,i,s,r){const{allSize:n,limit:a,result:o,size:h}=await this.user.getAssemblies(t,e,i,s,r);return{allSize:n,limit:a,list:o.map((t=>new et(t,this))),size:h,start:t}}deleteAssembly(t){return this.user.deleteAssembly(t)}}class rt{constructor(){this.subscribers={}}clear(){this.subscribers={}}emit(t){if(this.subscribers[t.type]){const e=[...this.subscribers[t.type]];this.subscribers[t.type]=this.subscribers[t.type].filter((t=>!t.once)),e.forEach((e=>e.callback(t)))}}on(t,e){!this.subscribers[t]&&(this.subscribers[t]=[]),this.subscribers[t].push({type:t,callback:e})}once(t,e){!this.subscribers[t]&&(this.subscribers[t]=[]),this.onces.push({type:t,callback:e,once:!0})}remove(t,e){this.subscribers[t]&&(this.subscribers[t]=this.subscribers[t].filter((i=>i.type!==t&&i.callback!==e)))}}return{createClient:async t=>{const e=new st(t);return t.APIToken&&await e.loginWithToken(t.APIToken),e}}}));